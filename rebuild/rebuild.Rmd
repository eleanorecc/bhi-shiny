---
title: "Rebuild"
output: html_document
---

```{r libraries}
library(magrittr)
library(readr)
library(stringr)
library(dplyr)
library(tidyr)
library(sp)
library(RSQLite)
library(DBI)
library(here)
library(sf)
```

## Make Database

```{r make database}
## dont change working directory, 
## but create dir_main path to dashboard folder
dir_main <- here()
if(length(grep("dashboard", dir_main, value = TRUE)) == 0){
  dir_main <- here("dashboard")
}

## in R console:
dbloc <- here("dashboard/data/bhi.db")
bhidbconn <- dbConnect(SQLite(), dbname = dbloc)
sql <- read_lines("bhidb.sql") %>% 
  str_remove("\t") %>% 
  paste(collapse = "") %>% 
  str_split("(?<=;)") %>% 
  unlist()
for(s in sql[str_length(sql) > 1]){
  dbExecute(bhidbconn, s)
}
dbDisconnect(bhidbconn)

## in terminal:
## cd dashboard/data
## pwd
## sqlite3 bhi.db
## .read bhidb.sql
## .schema
## .exit
```

## Update `global.R` and set Global Vars/Values

```{r setup}
source(here("rebuild/rebuild.R"))

## Assessment Info ----
## global variables/values to be used throughout the app
assess_year <- 2020
bhi_version <- "v2021"
## folder in bhi repo where assessment scores are located
scenario_folder <- "index"

## these urls should point to the most recent versions of everything
## note the raw github urls are invalid; these are used to construct longer, valid urls 
## eg for making data source tables for each goal page from the raw goal prep docs
gh_api_bhiprep <- "https://api.github.com/repos/OHI-Baltic/bhi-prep/git/trees/master?recursive=1"
gh_raw_bhiprep <- "https://raw.githubusercontent.com/OHI-Baltic/bhi-prep/master"
gh_raw_bhi <- "https://raw.githubusercontent.com/OHI-Baltic/bhi/master"
gh_prep <- "https://github.com/OHI-Baltic/bhi-prep"

## update global.R
globalr <- readLines(file.path(dir_main, "global.R"))

globalr[grep("assess_year", globalr)] <- sprintf("assess_year <- %s", assess_year)
globalr[grep("bhi_version", globalr)] <- sprintf("bhi_version <- \"%s\"", bhi_version)
globalr[grep("scenario_folder", globalr)] <- sprintf("scenario_folder <- \"%s\"", scenario_folder)

globalr[grep("gh_api_bhiprep", globalr)] <- sprintf("gh_api_bhiprep <- \"%s\"", gh_api_bhiprep)
globalr[grep("gh_raw_bhiprep", globalr)] <- sprintf("gh_raw_bhiprep <- \"%s\"", gh_raw_bhiprep)
globalr[grep("gh_raw_bhi", globalr)] <- sprintf("gh_raw_bhi <- \"%s\"", gh_raw_bhi)
globalr[grep("gh_prep", globalr)] <- sprintf("gh_prep <- \"%s\"", gh_prep)

writeLines(globalr, file.path(dir_main, "global.R"))


## source the shiny app global.R to set some global variables/values
## to be used throughout the app
source(here("dashboard/global.R"))
```

## Save Data/Tables in Database

```{r make tables}
## spatial look up tables
Regions <- read_csv(sprintf("%s/%s/layers/rgns_complete.csv", gh_raw_bhi, scenario_folder)) %>% 
  select(region_id, subbasin, eez, region_name, area_km2 = region_area_km2, region_order)

Subbasins <- read_csv(sprintf("%s/%s/layers/rgns_complete.csv", gh_raw_bhi, scenario_folder)) %>% 
  distinct(helcom_id, region_id = subbasin_id, subbasin, area_km2 = subbasin_area_km2, subbasin_order) %>% 
  mutate(region_id = paste("BHI", region_id, sep = "-"))

## goals info
## update goal descriptions in bhi repo version for changes to apply everywhere...
Goals <- read_csv(sprintf("%s/%s/conf/goals.csv", gh_raw_bhi, scenario_folder)) %>% 
  select(goal, goal_name = name, description)

## data sources table
## see rebuild.R for make_data_table function
DataSources <- make_data_table(gh_raw_bhiprep, bhi_version)

## scores
scores <- read_csv(sprintf("%s/%s/scores.csv", gh_raw_bhi, scenario_folder), col_types = cols())

## check if layers in bhi-prep repo match those registered in bhi/layers.csv
## if not scores.csv may need to be recalculated, 
## but also could be that extra layers were calculated but not used
# ghlayers <- sort(list_prep_layers(gh_api_bhiprep))
# lyrcsvfiles <- sort(readr::read_csv(sprintf("%s/%s/layers.csv", gh_raw_bhi, scenario_folder))$filename)
# lyrcsvfiles %in% paste0(ghlayers, ".csv")

## need year column
## save data to dashboard database
IndexScores <- scores %>% 
  mutate(year = ifelse("year" %in% names(scores), year, assess_year)) %>% 
  select(region_id, dimension, goal, score, year)
```

```{r save tables}
## connect to database and write tables
dbloc <- here("dashboard/data/bhi.db")
bhidbconn <- dbConnect(SQLite(), dbname = dbloc)
for(tab in c("Goals", "Regions", "Subbasins", "DataSources", "IndexScores")){
  dbWriteTable(
    conn = bhidbconn,
    name = tab,
    value = get(tab),
    row.names = FALSE,
    append = TRUE,
    binary = TRUE
  )
}
dbDisconnect(bhidbconn)
```

## Spatial Datasets

```{r save spatial files as rds}
## spatial data is saved as of august 2021 in shared folder on gunvor
dir_sp <- "/Users/eleanorecampbell/Desktop/GitHub/bhi-data/BHI 3.0/Spatial"

## make lower resolution files for visualization, don't need same high resolution as for analysis
## also reproject to EPSG:4326 
## Leaflet expects point/line/shape data to be specified in lat/long using WGS 84 (a.k.a. EPSG:4326)
## https://rstudio.github.io/leaflet/projections.html
## save as rds files

## regions shapefile
if(!file.exists(file.path(dir_main, "data", "regions.rds"))){
  st_read(file.path(dir_sp, "bhi_regions")) %>%
    select(region_id = bhi_id) %>% 
    st_transform(crs = 4326) %>% 
    rmapshaper::ms_simplify() %>% 
    as_Spatial() %>% 
    saveRDS(file.path(dir_main, "data", "regions.rds"))
}
## subbasins shapefile:
if(!file.exists(file.path(dir_main, "data", "subbasins.rds"))){
  st_read(file.path(dir_sp, "bhi_subbasins")) %>% 
    select(region_id = sbsn_id) %>% 
    st_transform(crs = 4326) %>% 
    rmapshaper::ms_simplify() %>% 
    as_Spatial() %>% 
    saveRDS(file.path(dir_main, "data", "subbasins.rds"))
}
```


## Make Flowerplots



## Update Text on Goal Pages


